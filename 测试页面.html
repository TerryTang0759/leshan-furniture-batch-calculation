<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡æŠ•å½±é¢ç§¯è®¡ç®—æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .input-group {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }
        .input-group label {
            font-weight: bold;
            min-width: 80px;
        }
        .input-group input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 120px;
        }
        button {
            background: #007aff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .results {
            margin-top: 30px;
        }
        .stats {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ  ä¹å±±å®¶å…·å®šåˆ¶ - æ‰¹é‡æŠ•å½±é¢ç§¯è®¡ç®—æµ‹è¯•</h1>
        
        <!-- è®¡ç®—é€»è¾‘è¯´æ˜ -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #007aff;">
            <h3 style="color: #007aff; margin-top: 0;">ğŸ“‹ è®¡ç®—é€»è¾‘è¯´æ˜</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 14px;">
                <div>
                    <h4 style="color: #2c3e50; margin: 10px 0 5px 0;">ğŸ”¢ è¾“å…¥å‚æ•°</h4>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li>æŸœä½“é«˜åº¦ (mm)</li>
                        <li>æŸœä½“å®½åº¦ (mm)</li>
                        <li>æŸœä½“æ·±åº¦ (mm)</li>
                    </ul>
                    
                    <h4 style="color: #2c3e50; margin: 15px 0 5px 0;">ğŸ“ è‡ªåŠ¨è®¡ç®—éš”æ¿</h4>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li>æ¨ªéš”æ¿æ•° = âŒŠé«˜åº¦Ã·400âŒ‹ + 1</li>
                        <li>çºµéš”æ¿æ•° = âŒŠå®½åº¦Ã·1000âŒ‹ + 1</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #2c3e50; margin: 10px 0 5px 0;">ğŸ—ï¸ æ‹†æ¿é¢ç§¯è®¡ç®—</h4>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li>é¡¶æ¿+åº•æ¿ = 2Ã—(å®½Ã—æ·±)</li>
                        <li>å·¦å³ä¾§æ¿ = 2Ã—(æ·±Ã—é«˜)</li>
                        <li>èƒŒæ¿ = å®½Ã—é«˜</li>
                        <li>æ¨ªéš”æ¿ = æ¨ªéš”æ¿æ•°Ã—(å®½Ã—æ·±)</li>
                        <li>ç«–éš”æ¿ = ç«–éš”æ¿æ•°Ã—(æ·±Ã—é«˜)</li>
                    </ul>
                    
                    <h4 style="color: #2c3e50; margin: 15px 0 5px 0;">ğŸ’° æŠ•å½±é¢ç§¯å•ä»·</h4>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li>æŠ•å½±é¢ç§¯ = å®½Ã—é«˜</li>
                        <li>æ‹†æ¿æ€»ä»· = æ‹†æ¿æ€»é¢ç§¯Ã—æè´¨å•ä»·</li>
                        <li>æŠ•å½±é¢ç§¯å•ä»· = æ‹†æ¿æ€»ä»·Ã·æŠ•å½±é¢ç§¯</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="input-group">
            <label>é«˜åº¦(mm):</label>
            <input type="number" id="height" value="2400" placeholder="2400">
            
            <label>å®½åº¦(mm):</label>
            <input type="number" id="width" value="1800" placeholder="1800">
            
            <label>æ·±åº¦(mm):</label>
            <input type="number" id="depth" value="600" placeholder="600">
        </div>
        
        <button onclick="calculateAll()" id="calcBtn">ğŸš€ å¼€å§‹æ‰¹é‡è®¡ç®—</button>
        <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
        
        <div id="errorMsg" class="error" style="display: none;"></div>
        
        <div id="loading" class="loading" style="display: none;">
            â³ æ­£åœ¨ä»MongoDBåŠ è½½æ•°æ®å¹¶è®¡ç®—...
        </div>
        
        <div id="results" class="results" style="display: none;">
            <div class="stats" id="stats"></div>
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th>æè´¨åç§°</th>
                        <th>å“ç‰Œ</th>
                        <th>æè´¨å•ä»·</th>
                        <th>æ‹†æ¿æ€»ä»·</th>
                        <th>æŠ•å½±é¢ç§¯å•ä»·</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        async function calculateAll() {
            const height = parseFloat(document.getElementById('height').value);
            const width = parseFloat(document.getElementById('width').value);
            const depth = parseFloat(document.getElementById('depth').value);
            
            if (!height || !width || !depth || height <= 0 || width <= 0 || depth <= 0) {
                showError('è¯·æ­£ç¡®å¡«å†™é«˜å®½æ·±ä¸‰ä¸ªå°ºå¯¸ï¼');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('errorMsg').style.display = 'none';
            document.getElementById('calcBtn').disabled = true;
            
            try {
                // è°ƒç”¨æ‰¹é‡è®¡ç®—API
                const response = await fetch('/api/batch-calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        height: height,
                        width: width,
                        depth: depth
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayResults(data);
                } else {
                    showError('è®¡ç®—å¤±è´¥: ' + data.message);
                }
                
            } catch (error) {
                showError('ç½‘ç»œé”™è¯¯: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('calcBtn').disabled = false;
            }
        }
        
        function displayResults(data) {
            const results = data.data;
            const stats = data.stats;
            const steps = stats.calculationSteps;
            
            // æ˜¾ç¤ºè¯¦ç»†è®¡ç®—è¿‡ç¨‹
            document.getElementById('stats').innerHTML = `
                <h3>ğŸ“Š è¯¦ç»†è®¡ç®—è¿‡ç¨‹</h3>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #ffc107;">
                    <h4 style="margin: 0 0 10px 0; color: #856404;">ğŸ”¢ è¾“å…¥å‚æ•°</h4>
                    <p style="margin: 5px 0;"><strong>é«˜åº¦:</strong> ${steps.input.height}mm</p>
                    <p style="margin: 5px 0;"><strong>å®½åº¦:</strong> ${steps.input.width}mm</p>
                    <p style="margin: 5px 0;"><strong>æ·±åº¦:</strong> ${steps.input.depth}mm</p>
                </div>
                
                <div style="background: #d1ecf1; padding: 15px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #17a2b8;">
                    <h4 style="margin: 0 0 10px 0; color: #0c5460;">ğŸ“ éš”æ¿æ•°é‡è®¡ç®—</h4>
                    <p style="margin: 5px 0;"><strong>æ¨ªéš”æ¿æ•°:</strong> ${steps.shelfCalculation.formula.horizontal}</p>
                    <p style="margin: 5px 0;"><strong>çºµéš”æ¿æ•°:</strong> ${steps.shelfCalculation.formula.vertical}</p>
                </div>
                
                <div style="background: #d4edda; padding: 15px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #28a745;">
                    <h4 style="margin: 0 0 10px 0; color: #155724;">ğŸ—ï¸ æ‹†æ¿é¢ç§¯è®¡ç®—</h4>
                    <p style="margin: 5px 0; font-size: 13px;"><strong>é¡¶æ¿+åº•æ¿:</strong> ${steps.areaCalculation.topBottom}</p>
                    <p style="margin: 5px 0; font-size: 13px;"><strong>å·¦å³ä¾§æ¿:</strong> ${steps.areaCalculation.leftRight}</p>
                    <p style="margin: 5px 0; font-size: 13px;"><strong>èƒŒæ¿:</strong> ${steps.areaCalculation.back}</p>
                    <p style="margin: 5px 0; font-size: 13px;"><strong>æ¨ªéš”æ¿:</strong> ${steps.areaCalculation.horizontalShelves}</p>
                    <p style="margin: 5px 0; font-size: 13px;"><strong>ç«–éš”æ¿:</strong> ${steps.areaCalculation.verticalShelves}</p>
                    <p style="margin: 10px 0 5px 0; font-weight: bold; color: #155724;"><strong>æ‹†æ¿æ€»é¢ç§¯:</strong> ${steps.areaCalculation.totalArea}</p>
                </div>
                
                <div style="background: #f8d7da; padding: 15px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #dc3545;">
                    <h4 style="margin: 0 0 10px 0; color: #721c24;">ğŸ’° æŠ•å½±é¢ç§¯è®¡ç®—</h4>
                    <p style="margin: 5px 0;"><strong>æŠ•å½±é¢ç§¯:</strong> ${steps.projectionCalculation.formula}</p>
                </div>
                
                <div style="background: #e2e3e5; padding: 15px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #6c757d;">
                    <h4 style="margin: 0 0 10px 0; color: #383d41;">ğŸ“ˆ ç»Ÿè®¡ç»“æœ</h4>
                    <p style="margin: 5px 0;"><strong>æè´¨æ€»æ•°:</strong> ${stats.totalMaterials} ç§</p>
                    <p style="margin: 5px 0;"><strong>å¹³å‡å•ä»·:</strong> Â¥${Math.round(stats.avgPrice)}/ã¡</p>
                    <p style="margin: 5px 0;"><strong>æœ€ä½å•ä»·:</strong> Â¥${Math.round(stats.minPrice)}/ã¡</p>
                    <p style="margin: 5px 0;"><strong>æœ€é«˜å•ä»·:</strong> Â¥${Math.round(stats.maxPrice)}/ã¡</p>
                </div>
            `;
            
            // æ˜¾ç¤ºè¡¨æ ¼æ•°æ®
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            results.forEach((result, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.name}</td>
                    <td>${result.brand}</td>
                    <td>Â¥${result.materialPrice}/ã¡</td>
                    <td>Â¥${result.totalPrice.toFixed(2)}</td>
                    <td><strong>Â¥${result.roundedPrice}/ã¡</strong></td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('results').style.display = 'block';
        }
        
        function showError(message) {
            document.getElementById('errorMsg').textContent = message;
            document.getElementById('errorMsg').style.display = 'block';
        }
        
        function clearResults() {
            document.getElementById('results').style.display = 'none';
            document.getElementById('errorMsg').style.display = 'none';
            document.getElementById('height').value = '';
            document.getElementById('width').value = '';
            document.getElementById('depth').value = '';
        }
        
        // é¡µé¢åŠ è½½æ—¶æµ‹è¯•APIè¿æ¥
        window.onload = async function() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                if (data.success) {
                    console.log('âœ… APIè¿æ¥æ­£å¸¸ï¼ŒMongoDBæ•°æ®:', data.mongodb.documentCount, 'æ¡');
                } else {
                    console.log('âš ï¸ APIè¿æ¥å¼‚å¸¸');
                }
            } catch (error) {
                console.log('âŒ APIè¿æ¥å¤±è´¥:', error);
            }
        };
    </script>
</body>
</html>
